package threat

import (
	"github.com/rs/zerolog/log"
	"net/http"
	"oauth2-pentester/pkg/derror"
	"oauth2-pentester/pkg/logger"
)

type SubRefreshToken struct {
	baseThreat

	clientID            string
	malwareClientID     string
	malwareClientSecret string

	client *http.Client
}

func NewSubRefreshToken(
	authURL,
	username,
	password,
	tokenURL,
	clientID,
	malwareClientID,
	malwareClientSecret,
	elementEmailName,
	elementPassName,
	elementEnterID string,
	client *http.Client) *SubRefreshToken {

	threat := new(SubRefreshToken)
	threat.authURL = authURL
	threat.username = username
	threat.password = password
	threat.tokenURL = tokenURL
	threat.clientID = clientID
	threat.malwareClientID = malwareClientID
	threat.malwareClientSecret = malwareClientSecret
	threat.elementEmailName = elementEmailName
	threat.elementPassName = elementPassName
	threat.elementEnterID = elementEnterID
	threat.client = client

	return threat
}

func (t *SubRefreshToken) Analyze() (bool, derror.Error) {
	vcreds, err := t.auth(t.malwareClientID, t.malwareClientSecret, "")
	if err != nil {
		return false, err
	}

	if vcreds.RefreshToken == "" {
		log.Error().Msg(logger.FailGetTokenPair)
		return false, nil
	}

	_, refreshToken, err := requestTokenPair(codeParam,
		vcreds.RefreshToken,
		refreshTokenGrantType,
		t.tokenURL,
		t.clientID,
		"",
		"",
		redirectURI,
	)
	if err != nil {
		return false, err
	}
	if refreshToken == "" {
		return true, nil
	}

	return false, nil
}

func (t *SubRefreshToken) String() string {
	return "Подмена токена обновления при обновлении токена доступа"
}
