package threat

import (
	"github.com/rs/zerolog/log"
	"net/http"
	"oauth2-pentester/pkg/derror"
	"oauth2-pentester/pkg/logger"
	"strings"
)

type NoTLS struct {
	getTokenURL string
	client      *http.Client
}

func NewNoTLS(getTokenURL string, client *http.Client) *NoTLS {
	noTLS := new(NoTLS)
	noTLS.getTokenURL = getTokenURL
	noTLS.client = client

	return noTLS
}

func (t *NoTLS) Analyze() (bool, derror.Error) {
	getTokenURL := strings.Replace(t.getTokenURL, "https", "http", -1)

	r, err := http.NewRequest("POST", getTokenURL, http.NoBody)
	if err != nil {
		log.Error().Err(err).Msg(logger.FailCreateRequest)
		return false, derror.NewAnalyze()
	}

	resp, err := t.client.Do(r)
	if resp != nil {
		defer resp.Body.Close()
	}
	if err != nil {
		log.Error().Err(err).Msg(logger.FailDoRequest)
		return false, derror.NewAnalyze()
	}
	if resp.StatusCode != http.StatusMovedPermanently {
		log.Warn().Int(logger.StatusCodeField, resp.StatusCode).Msg(logger.FailAnalyze)
		return false, nil
	}

	return true, nil
}

func (t *NoTLS) String() string {
	return "При получении токена доступа соединение не защищено шифрованием."
}
